<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 테스트 - Vanilla JS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 사내 디자인 시스템 클래스 모사 */
        .bg-bg-02 { background-color: #f8f9fa; }
        .bg-spectrum-01 { background-color: #e3f2fd; }
        .bg-spectrum-02 { background-color: #f3e5f5; }
        .text-text-01 { color: #111111; }
        .text-text-03 { color: #888888; }
    </style>
</head>
<body class="min-h-screen bg-bg-02 pb-[80px]">

<div class="space-y-[24px]">
    <header class="p-[16px] bg-white border-b text-center font-bold text-[18px]">
        실시간 테스트
    </header>

    <section class="p-[24px] space-y-[32px] bg-spectrum-01 mx-[16px] rounded-lg">
        <h2 class="font-bold">카운터 테스트</h2>
        <div class="flex flex-col items-center gap-[20px]">
            <div id="counter-value" class="text-[40px] font-bold text-text-01">0</div>
            <div class="flex gap-[10px]">
                <button id="decrement"
                        class="w-[50px] h-[50px] bg-white border rounded-lg text-[24px] shadow-sm">-
                </button>
                <button id="increment"
                        class="w-[50px] h-[50px] bg-blue-500 text-white rounded-lg text-[24px] shadow-sm">
                    +
                </button>
            </div>
        </div>
    </section>

    <section class="p-[24px] space-y-[16px] bg-spectrum-02 mx-[16px] rounded-lg">
        <h2 class="font-bold">종목 리스트</h2>

        <div class="flex gap-[10px] mt-[8px]">
            <button class="flex-1 bg-blue-500 text-white p-[12px] rounded-lg font-bold"
                    onclick="requestAll()">전체 구독
            </button>
            <button class="flex-1 bg-white border p-[12px] rounded-lg font-bold"
                    onclick="console.log('전체 구독 취소')">전체 구독 취소
            </button>
        </div>

        <div id="stock-list-container" class="space-y-[12px]"></div>
    </section>
</div>

<script>
    /** 1. 데이터 모델 (StockItem) **/
    const StockItem = {
        createExamples: () => [
            {
                name: "삼성전자",
                symbol: "005930",
                price: "83600",
                sign: "1",
                diff: "1200",
                rate: "1.46",
                tradingVolume: "12,345,678주",
                tradingAmount: "1조2345억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/005930.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "SK하이닉스",
                symbol: "000660",
                price: "180000",
                sign: "2",
                diff: "3000",
                rate: "1.69",
                tradingVolume: "2,345,678주",
                tradingAmount: "4230억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/000660.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "삼성바이오로직스",
                symbol: "207940",
                price: "780000",
                sign: "4",
                diff: "5000",
                rate: "-0.64",
                tradingVolume: "123,456주",
                tradingAmount: "960억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/207940.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "LG에너지솔루션",
                symbol: "373220",
                price: "410000",
                sign: "5",
                diff: "8000",
                rate: "-1.91",
                tradingVolume: "234,567주",
                tradingAmount: "950억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/373220.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "삼성SDI",
                symbol: "006400",
                price: "550000",
                sign: "1",
                diff: "7000",
                rate: "1.29",
                tradingVolume: "345,678주",
                tradingAmount: "1900억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/006400.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "현대차",
                symbol: "005380",
                price: "260000",
                sign: "2",
                diff: "4000",
                rate: "1.56",
                tradingVolume: "456,789주",
                tradingAmount: "1200억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/005380.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "기아",
                symbol: "000270",
                price: "120000",
                sign: "1",
                diff: "2000",
                rate: "1.69",
                tradingVolume: "567,890주",
                tradingAmount: "680억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/000270.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "POSCO홀딩스",
                symbol: "005490",
                price: "600000",
                sign: "4",
                diff: "10000",
                rate: "-1.64",
                tradingVolume: "678,901주",
                tradingAmount: "4000억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/005490.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "LG화학",
                symbol: "051910",
                price: "350000",
                sign: "5",
                diff: "6000",
                rate: "-1.68",
                tradingVolume: "789,012주",
                tradingAmount: "2700억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/051910.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "NAVER",
                symbol: "035420",
                price: "210000",
                sign: "1",
                diff: "3000",
                rate: "1.45",
                tradingVolume: "890,123주",
                tradingAmount: "1870억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/035420.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "카카오",
                symbol: "035720",
                price: "48000",
                sign: "2",
                diff: "800",
                rate: "1.69",
                tradingVolume: "901,234주",
                tradingAmount: "430억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/035720.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "삼성물산",
                symbol: "028260",
                price: "120000",
                sign: "1",
                diff: "1500",
                rate: "1.27",
                tradingVolume: "123,456주",
                tradingAmount: "150억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/028260.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            },
            {
                name: "현대모비스",
                symbol: "012330",
                price: "230000",
                sign: "4",
                diff: "3000",
                rate: "-1.29",
                tradingVolume: "234,567주",
                tradingAmount: "540억원",
                imageUrl: "https://dev.kbox.kis-static.finance/images/icon/kr/012330.png",
                exchangeCodeForLanding: "KRX",
                nationForLanding: "KR"
            }
        ],
        createExamplesMap: function() {
            return this.createExamples().reduce((map, item) => {
                map[item.symbol] = item;
                return map;
            }, {});
        }
    };

    /** 2. 상태 관리 (Counter) **/
    let count = 0;
    const counterDisplay = document.getElementById('counter-value');
    const btnIncr = document.getElementById('increment');
    const btnDecr = document.getElementById('decrement');

    let stockMap = StockItem.createExamplesMap();

    function getBridge(name) {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      if (/android/i.test(ua)) {
        console.log("android");
        return window[name];
      } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
        console.log("iOS");
        return window.webkit?.messageHandlers;
      } else {
        console.log("unknown platform");
        return null;
      }
    }

    function executeBridge(functionName, data = null, bridgeName ='MtsBridge', ) {
      const bridge = getBridge(bridgeName);
      if (!bridge) {
        console.warn("No bridge available");
        return;
      }

      if (typeof bridge[functionName] === "function") {
        data != null ? bridge[functionName](data) : bridge[functionName]();
      } else if (typeof bridge[functionName] === "object") {
        bridge[functionName].postMessage(data != null ? data : "");
      } else {
        console.warn(`Bridge does not support: ${functionName}`);
      }
    }

    function updateCounter(value) {
        count += value;
        counterDisplay.innerText = count;
    }

    function requestAll(){
        const items = JSON.stringify(StockItem.createExamples());
        console.log(items);
        executeBridge('requestRealtimeQuotes', items);
    }

    function subscribe(_item){
        const item = JSON.stringify(_item);
        console.log(item);
        executeBridge('subscribeRealtimeQuote', item);
    }

    function unsubscribe(_item){
        const item = JSON.stringify(_item);
        executeBridge('unSubscribeRealtimeQuote', item);
    }

    function toNumber(str) {
        return Number(String(str).replace(/[^0-9.\-]/g, ''));
    }

    function receivedQuote(_item) {
        const item = JSON.parse(_item);
        console.log(item);
        console.log(_item);
        if (!item.symbol) return;
        stockMap[item.symbol] = item;
        renderStockList();
    }

    function cancelAll(){

    }

    btnIncr.addEventListener('click', () => updateCounter(1));
    btnDecr.addEventListener('click', () => updateCounter(-1));

    /** 3. 유틸리티 함수 (Price Color & Sign) **/
    const getPriceColor = (sign) => {
        if (['1', '2'].includes(sign)) return 'text-[#F44336]'; // 상승 (Red)
        if (['4', '5'].includes(sign)) return 'text-[#2979FF]'; // 하락 (Blue)
        return 'text-text-01';
    };

    const getSignChar = (sign) => {
        if (sign === '2') return '▲';
        if (sign === '5') return '▼';
        return '';
    };

    /** 4. 렌더링 함수 (Stock List) **/
    function renderStockList() {
        const container = document.getElementById('stock-list-container');
        const items = Object.values(stockMap);


        // 기존 아이템 모두 제거
        container.innerHTML = '';

        container.innerHTML = items.map(item => `
            <div class="flex items-center justify-between p-[16px] bg-white rounded-[16px] shadow-sm stock-item" data-symbol="${item.symbol}">
                <div class="flex items-center gap-[12px]">
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-[40px] h-[40px] rounded-full" />
                    <div class="flex flex-col">
                        <span class="text-[16px] font-bold text-text-01">${item.name}</span>
                        <span class="text-[12px] text-text-03">${item.symbol}</span>
                    </div>
                </div>
                <divse class="flex flex-col items-end">
                    <span class="text-[16px] font-bold ${getPriceColor(item.sign)}">
                        ${toNumber(item.price).toLocaleString()}원
                    </span>
                    <div class="flex gap-[4px] text-[12px] ${getPriceColor(item.sign)}">
                        <span>${getSignChar(item.sign)} ${toNumber(item.diff).toLocaleString()}</span>
                        <span>(${item.rate}%)</span>
                    </div>
                </div>
            </div>
        `).join('');

        items.forEach(item => {
                subscribe(item);
        });

        container.querySelectorAll('.stock-item').forEach(el => {

            el.addEventListener('click', function() {
                const symbol = this.getAttribute('data-symbol');
                const item = stockMap[symbol];
                if (item) subscribe(item);
            });
        });
    }
    // 초기화
    renderStockList();
</script>
</body>
</html>
